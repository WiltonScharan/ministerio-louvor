<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Minist√©rio de Louvor ‚Äì Igreja Hermom</title>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<style>
:root {
  --primary: #D84C28; --primary-dark: #B83E20; --primary-light: #E86040;
  --primary-bg: #FFF0EC; --primary-badge-bg: #FFE0D8; --primary-badge-text: #C44520;
  --bg: #f0f2f5; --surface: #ffffff; --surface2: #f9fafb; --border: #e5e7eb;
  --text: #1f2937; --text-soft: #6b7280; --text-muted: #9ca3af;
  --tab-bg: #ffffff; --table-head: #f9fafb; --input-bg: #fafafa;
  --card-shadow: 0 1px 3px rgba(0,0,0,0.07);
  --banner-bg: #fef9c3; --banner-border: #fde68a; --banner-text: #92400e;
}
[data-theme="dark"] {
  --bg:#111827; --surface:#1f2937; --surface2:#374151; --border:#374151;
  --text:#f9fafb; --text-soft:#9ca3af; --text-muted:#6b7280;
  --tab-bg:#1f2937; --table-head:#374151; --input-bg:#374151;
  --card-shadow:0 1px 3px rgba(0,0,0,0.3);
  --primary-bg:#2d1a14; --primary-badge-bg:#4a2010; --primary-badge-text:#F07050;
  --banner-bg:#3b2f00; --banner-border:#7a5a00; --banner-text:#fde68a;
}
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Segoe UI',sans-serif; background:var(--bg); min-height:100vh; color:var(--text); transition:background 0.2s,color 0.2s; }
.header { background:linear-gradient(135deg,var(--primary),var(--primary-light)); color:white; padding:10px 24px; }
.header-top { display:flex; align-items:center; gap:14px; }
.header-titles h1 { font-size:20px; font-weight:700; }
.header-titles .sub { font-size:12px; opacity:.85; margin-top:2px; }
.header-actions { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:10px; }
.mode-badge { background:rgba(255,255,255,0.2); padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; }
.mode-badge.editor { background:rgba(255,220,50,0.35); }
.btn-lock { background:rgba(255,255,255,0.15); border:none; color:white; padding:4px 12px; border-radius:20px; font-size:11px; cursor:pointer; }
.btn-lock:hover { background:rgba(255,255,255,0.25); }
.btn-theme { background:rgba(255,255,255,0.15); border:none; color:white; padding:4px 10px; border-radius:20px; font-size:13px; cursor:pointer; }
.btn-theme:hover { background:rgba(255,255,255,0.25); }
.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000; }
.modal { background:var(--surface); border-radius:16px; padding:32px; width:340px; text-align:center; }
.modal h2 { font-size:18px; color:var(--text); margin-bottom:8px; }
.modal p { font-size:13px; color:var(--text-soft); margin-bottom:20px; }
.modal input { width:100%; padding:10px 14px; border:1px solid var(--border); border-radius:8px; font-size:14px; text-align:center; letter-spacing:4px; outline:none; background:var(--input-bg); color:var(--text); }
.modal input:focus { border-color:var(--primary); }
.modal .error { color:#ef4444; font-size:12px; margin-top:8px; }
.modal-btns { display:flex; gap:8px; margin-top:16px; }
.tabs { background:var(--tab-bg); border-bottom:1px solid var(--border); display:flex; overflow-x:auto; padding:0 16px; }
.tab { padding:14px 16px; cursor:pointer; font-size:13px; font-weight:500; color:var(--text-soft); border-bottom:3px solid transparent; white-space:nowrap; background:none; border-top:none; border-left:none; border-right:none; transition:all 0.2s; }
.tab:hover { color:var(--primary); }
.tab.active { color:var(--primary); border-bottom-color:var(--primary); }
.content { max-width:1100px; margin:0 auto; padding:24px 16px; }
.section-title { font-size:20px; font-weight:700; color:var(--text); margin-bottom:20px; }
.view-only-banner { background:var(--banner-bg); border:1px solid var(--banner-border); color:var(--banner-text); padding:10px 16px; border-radius:8px; font-size:13px; margin-bottom:16px; }
.form-box { background:var(--surface); padding:20px; border-radius:12px; margin-bottom:16px; box-shadow:var(--card-shadow); display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
.form-group { display:flex; flex-direction:column; gap:4px; }
.form-group.full { grid-column:span 2; }
.form-group label { font-size:12px; font-weight:600; color:var(--text-soft); }
.form-group input,.form-group select,.form-group textarea { padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:13px; color:var(--text); background:var(--input-bg); outline:none; font-family:inherit; }
.form-group input:focus,.form-group select:focus,.form-group textarea:focus { border-color:var(--primary); background:var(--surface); }
.form-actions { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px; }
.btn-primary { background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; }
.btn-primary:hover { background:var(--primary-dark); }
.btn-secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); padding:10px 16px; border-radius:8px; font-size:13px; cursor:pointer; }
.btn-green { background:#059669; color:white; border:none; padding:10px 20px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; }
.btn-green:hover { background:#047857; }
.icon-btn { background:none; border:none; cursor:pointer; font-size:15px; padding:4px; opacity:.6; }
.icon-btn:hover { opacity:1; }
.status-btn { background:none; border:none; cursor:pointer; font-size:12px; white-space:nowrap; color:var(--text); }
.table { width:100%; border-collapse:collapse; margin-top:20px; background:var(--surface); border-radius:12px; overflow:hidden; box-shadow:var(--card-shadow); font-size:13px; }
.table th { background:var(--table-head); padding:11px 14px; text-align:left; font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px; }
.table td { padding:11px 14px; border-top:1px solid var(--border); color:var(--text); }
.table tr:hover td { background:var(--surface2); }
.badge { background:var(--primary-badge-bg); color:var(--primary-badge-text); padding:3px 8px; border-radius:20px; font-size:11px; font-weight:600; }
.badge-green { background:#d1fae5; color:#059669; }
.badge-blue { background:#dbeafe; color:#1d4ed8; }
[data-theme="dark"] .badge-green { background:#064e3b; color:#6ee7b7; }
[data-theme="dark"] .badge-blue { background:#1e3a5f; color:#93c5fd; }
.search-input { width:100%; padding:10px 14px; border:1px solid var(--border); border-radius:8px; font-size:13px; margin-top:16px; background:var(--surface); color:var(--text); outline:none; }
.search-input:focus { border-color:var(--primary); }
.cards-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; margin-top:16px; }
.card { background:var(--surface); border-radius:12px; padding:16px; box-shadow:var(--card-shadow); }
.card-header { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; }
.card-title { font-weight:700; font-size:14px; color:var(--text); }
.card-sub { font-size:12px; color:var(--text-muted); margin-top:4px; }
.card-obs { font-size:12px; color:var(--text-soft); margin-top:8px; background:var(--surface2); padding:8px; border-radius:6px; white-space:pre-wrap; }
.card-link { display:inline-block; font-size:12px; color:var(--primary); text-decoration:none; }
.card-actions { display:flex; gap:4px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
.mes-header { font-size:15px; font-weight:700; color:var(--text); margin:20px 0 8px; padding:8px 12px; background:var(--surface); border-radius:8px; }
.mes-header.mes-atual { background:var(--primary-bg); color:var(--primary); }
.row-destaque td { background:var(--primary-bg) !important; }
.regras-list { margin-top:20px; display:flex; flex-direction:column; gap:10px; }
.regra-card { background:var(--surface); border-radius:12px; padding:16px; box-shadow:var(--card-shadow); display:flex; gap:16px; align-items:flex-start; }
.regra-num { background:var(--primary); color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; flex-shrink:0; margin-top:2px; }
.regra-body { flex:1; }
.regra-titulo { font-weight:700; font-size:14px; color:var(--text); }
.regra-desc { font-size:13px; color:var(--text-soft); margin-top:6px; line-height:1.5; }
.regra-actions { display:flex; gap:2px; flex-shrink:0; }
.empty { text-align:center; padding:32px; color:var(--text-muted); font-size:14px; }
.escala-controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
.escala-controls select { padding:8px 12px; border:1px solid var(--border); border-radius:8px; font-size:13px; background:var(--surface); color:var(--text); outline:none; }
.print-wrap { margin-top:20px; overflow-x:auto; }
.print-table { border-collapse:collapse; font-size:12px; min-width:600px; background:white; box-shadow:var(--card-shadow); border-radius:8px; overflow:hidden; }
.print-table th { background:var(--primary); color:white; padding:8px 12px; text-align:center; font-size:11px; white-space:nowrap; border:1px solid var(--primary-dark); }
.print-table th.func-col { background:#374151; }
.print-table td { padding:7px 12px; border:1px solid #e5e7eb; text-align:center; font-size:12px; color:#1f2937; white-space:nowrap; }
.print-table tr:nth-child(even) td { background:#f9fafb; }
.print-table td.func-name { background:#1f2937 !important; color:white; font-weight:700; text-align:left; }
@keyframes bar1 { 0%,100%{height:6px} 50%{height:16px} }
@keyframes bar2 { 0%,100%{height:12px} 50%{height:20px} }
@keyframes bar3 { 0%,100%{height:18px} 50%{height:6px} }
@keyframes bar4 { 0%,100%{height:12px} 50%{height:20px} }
@keyframes bar5 { 0%,100%{height:6px} 50%{height:14px} }
.voice-bar { display:inline-block; width:3px; border-radius:2px; background:var(--primary); }
.listening .voice-bar:nth-child(1) { animation:bar1 0.5s ease-in-out infinite; }
.listening .voice-bar:nth-child(2) { animation:bar2 0.5s ease-in-out infinite 0.1s; }
.listening .voice-bar:nth-child(3) { animation:bar3 0.5s ease-in-out infinite 0.2s; }
.listening .voice-bar:nth-child(4) { animation:bar4 0.5s ease-in-out infinite 0.1s; }
.listening .voice-bar:nth-child(5) { animation:bar5 0.5s ease-in-out infinite 0.05s; }
/* METRONOMO */
.metro-circle { width:120px; height:120px; border-radius:50%; border:6px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:800; color:var(--text); margin:0 auto; transition:background 0.05s,border-color 0.05s; }
.metro-circle.beat { background:var(--primary); border-color:var(--primary); color:white; }
@media print { .no-print{display:none!important} body{background:white} .print-wrap{margin:0} }
@media (max-width:600px) { .form-box{grid-template-columns:1fr} .form-group.full{grid-column:span 1} .cards-grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div id="app"><div style="text-align:center;padding:60px;color:#888">Carregando...</div></div>
<script>
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyCfj6HRNRmCsaU7lSZ84rJC2Qp18sNNFLk",
  authDomain:"ministerio-louvor---hermom.firebaseapp.com",
  databaseURL:"https://ministerio-louvor---hermom-default-rtdb.firebaseio.com",
  projectId:"ministerio-louvor---hermom",
  storageBucket:"ministerio-louvor---hermom.firebasestorage.app",
  messagingSenderId:"1074507943287",
  appId:"1:1074507943287:web:ff3d404076242eef9f6572"
};
const EDITOR_PASSWORD = "DH#2026";
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

const FUNCOES = ["Ministro","Backing 1","Backing 2","Backing 3","Backing 4","Bateria","Baixo","Guitarra","Viol√£o","Teclado"];
const CULTOS  = ["Domingo","Quinta-feira","Vig√≠lia","Mulheres","Homens","Outro"];
const MESES   = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const NOTAS   = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const STATUS_LABELS = {pendente:"üü° Pendente",concluido:"üü¢ Conclu√≠do",cancelado:"üî¥ Cancelado"};

// C√≠rculo das quintas para calcular proximidade entre tons
const CIRCLE_OF_FIFTHS = ["C","G","D","A","E","B","F#","C#","G#","D#","A#","F"];
function toneDistance(a, b) {
  if (!a || !b) return 99;
  var flat = {"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#"};
  a = flat[a]||a; b = flat[b]||b;
  var ia = CIRCLE_OF_FIFTHS.indexOf(a), ib = CIRCLE_OF_FIFTHS.indexOf(b);
  if (ia===-1||ib===-1) return 6;
  var d = Math.abs(ia-ib); return Math.min(d,12-d);
}

let isEditor=false, activeTab="escala", showPasswordModal=false, passwordError="";
let showBirthdayPopup=true, editIndex=null, isDark=false;
let escala=[],louvores=[],aniversariantes=[],cronograma=[],regras=[];
let escalaMesFiltro=new Date().getMonth(), buscaLouvor="";

// Ferramentas
let ferraTab="transpositor";
let transResult=null, transOrigem="", transDestino="", transCifra="";
let medleyTipo="agitado", medleyResult=null;
let vozLouvor="", vozResult=null;
// Metr√¥nomo
let metroRunning=false, metroBPM=80, metroTimer=null, metroBeat=false, metroManualBPM="";

function emptyEscala(){return{data:"",culto:"",funcao:"",nome:"",obs:"",mes:new Date().getMonth()};}
function emptyLouvor(){return{titulo:"",artista:"",nota:"",bpm:"",link:"",trecho:""};}
let formEscala=emptyEscala(), formLouvor=emptyLouvor();
let formAniv={nome:"",dia:"",mes:"",funcao:"",tel:""};
let formCron={data:"",titulo:"",descricao:"",responsavel:"",status:"pendente"};
let formRegra={titulo:"",descricao:""};

function toggleTheme(){isDark=!isDark;document.documentElement.setAttribute("data-theme",isDark?"dark":"light");render();}

function initListeners(){
  ["escala","louvores","aniversariantes","cronograma","regras"].forEach(function(key){
    db.ref("ministerio/"+key).on("value",function(snap){
      var val=snap.val();
      if(key==="escala")          escala          =val?Object.values(val):[];
      if(key==="louvores")        louvores        =val?Object.values(val):[];
      if(key==="aniversariantes") aniversariantes =val?Object.values(val):[];
      if(key==="cronograma")      cronograma      =val?Object.values(val):[];
      if(key==="regras")          regras          =val?Object.values(val):[];
      render();
    });
  });
}
function saveData(key,arr){db.ref("ministerio/"+key).set(arr);}

function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function fmtDate(d){if(!d)return"";var p=d.split("-");return p[2]+"/"+p[1]+"/"+p[0];}
function getYoutubeId(url){if(!url)return null;var m=url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/);return m?m[1]:null;}

function togglePreview(btn,ytId,link){
  var preview=btn.parentElement.nextElementSibling;
  if(preview.style.display==="none"){
    preview.style.display="block";
    if(ytId){
      preview.innerHTML='<iframe width="100%" height="160" src="https://www.youtube.com/embed/'+ytId+'?autoplay=1" frameborder="0" allow="autoplay;encrypted-media" allowfullscreen style="border-radius:8px;display:block"></iframe>'+
        '<a href="'+link+'" target="_blank" style="display:inline-block;margin-top:6px;font-size:12px;color:var(--primary);text-decoration:none">‚Üó Abrir no YouTube</a>';
    } else if(link){
      preview.innerHTML='<a href="'+link+'" target="_blank" style="font-size:13px;color:var(--primary)">‚Üó Abrir link externo</a>';
    }
    btn.textContent="‚èπ Fechar";
  } else {
    preview.style.display="none"; preview.innerHTML=""; btn.textContent="‚ñ∂ Ouvir / Ver";
  }
}

function render(){
  var scrollY=window.scrollY;
  document.getElementById("app").innerHTML=
    renderBirthdayPopup()+
    (showPasswordModal?renderModal():"")+
    '<div class="header">'+
      '<div class="header-top">'+
        '<img src="hermom.png" style="width:48px;height:48px;object-fit:contain;flex-shrink:0;mix-blend-mode:multiply" />'+
        '<div class="header-titles"><h1>Minist√©rio de Louvor</h1><div class="sub">Igreja Hermom</div></div>'+
      '</div>'+
      '<div class="header-actions">'+
        '<span class="mode-badge '+(isEditor?"editor":"")+'">'+( isEditor?"‚úèÔ∏è Modo Editor":"üëÅÔ∏è Somente Visualiza√ß√£o")+'</span>'+
        (isEditor?'<button class="btn-lock" onclick="logout()">üîí Sair do modo editor</button>':'<button class="btn-lock" onclick="openModal()">üîë Entrar como editor</button>')+
        '<button class="btn-theme" onclick="toggleTheme()">'+( isDark?"‚òÄÔ∏è Claro":"üåô Escuro")+'</button>'+
      '</div>'+
    '</div>'+
    '<div class="tabs">'+
      [["escala","üìÖ Escala"],["louvores","üéµ Louvores"],["aniversariantes","üéÇ Aniversariantes"],["cronograma","üìã Cronograma"],["regras","üìú Regras"],["ferramentas","üé∏ Ferramentas"]].map(function(t){
        return '<button class="tab '+(activeTab===t[0]?"active":"")+'" onclick="setTab(\''+t[0]+'\')">'+t[1]+'</button>';
      }).join("")+
    '</div>'+
    '<div class="content">'+
      (!isEditor?'<div class="view-only-banner no-print">üëÅÔ∏è Modo visualiza√ß√£o. Clique em "Entrar como editor" para editar.</div>':"")+
      (activeTab==="escala"          ?renderEscala()         :"")+
      (activeTab==="louvores"        ?renderLouvores()       :"")+
      (activeTab==="aniversariantes" ?renderAniversariantes():"")+
      (activeTab==="cronograma"      ?renderCronograma()     :"")+
      (activeTab==="regras"          ?renderRegras()         :"")+
      (activeTab==="ferramentas"     ?renderFerramentas()    :"")+
    '</div>';
  window.scrollTo(0,scrollY);
  if(activeTab==="louvores"&&buscaLouvor!==""){var inp=document.querySelector(".search-input");if(inp){inp.focus();inp.setSelectionRange(inp.value.length,inp.value.length);}}
}

// BIRTHDAY
function renderBirthdayPopup(){
  if(!showBirthdayPopup)return"";
  var hoje=new Date(),dia=hoje.getDate(),mes=hoje.getMonth()+1;
  var lista=aniversariantes.filter(function(a){return parseInt(a.dia)===dia&&parseInt(a.mes)===mes;});
  if(!lista.length)return"";
  return'<div class="modal-bg" onclick="showBirthdayPopup=false;render()">'+
    '<div class="modal" onclick="event.stopPropagation()" style="max-width:360px">'+
      '<div style="font-size:48px;margin-bottom:8px">üéÇ</div>'+
      '<h2 style="color:var(--primary)">Anivers√°rio hoje!</h2>'+
      '<div style="margin:16px 0;display:flex;flex-direction:column;gap:10px">'+
        lista.map(function(a){
          return'<div style="background:var(--primary-bg);border-radius:10px;padding:12px 16px;text-align:left">'+
            '<div style="font-weight:700;font-size:15px;color:var(--text)">üéâ '+esc(a.nome)+'</div>'+
            (a.funcao?'<div style="font-size:12px;color:var(--primary);margin-top:2px">'+esc(a.funcao)+'</div>':"")+
            (a.tel?'<div style="font-size:12px;color:var(--text-soft);margin-top:2px">üì± '+esc(a.tel)+'</div>':"")+
          '</div>';
        }).join("")+
      '</div>'+
      '<button class="btn-primary" style="width:100%" onclick="showBirthdayPopup=false;render()">üôå Que Deus aben√ßoe!</button>'+
    '</div>'+
  '</div>';
}

// MODAL SENHA
function renderModal(){
  return'<div class="modal-bg" onclick="closeModal(event)">'+
    '<div class="modal" onclick="event.stopPropagation()">'+
      '<h2>üîë Modo Editor</h2><p>Digite a senha para habilitar a edi√ß√£o</p>'+
      '<input type="password" id="pwd-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key===\'Enter\')checkPwd()" autofocus />'+
      (passwordError?'<div class="error">'+passwordError+'</div>':"")+
      '<div class="modal-btns">'+
        '<button class="btn-secondary" style="flex:1" onclick="closeModal()">Cancelar</button>'+
        '<button class="btn-primary" style="flex:1" onclick="checkPwd()">Entrar</button>'+
      '</div>'+
    '</div>'+
  '</div>';
}
function openModal(){showPasswordModal=true;passwordError="";render();setTimeout(function(){var el=document.getElementById("pwd-input");if(el)el.focus();},50);}
function closeModal(e){if(!e||e.target.classList.contains("modal-bg")){showPasswordModal=false;render();}}
function checkPwd(){
  var v=(document.getElementById("pwd-input")||{}).value||"";
  if(v===EDITOR_PASSWORD){isEditor=true;showPasswordModal=false;render();}
  else{passwordError="Senha incorreta.";render();setTimeout(function(){var el=document.getElementById("pwd-input");if(el)el.focus();},50);}
}
function logout(){isEditor=false;render();}
function setTab(t){activeTab=t;editIndex=null;stopMetro();render();}

// ============================
// ESCALA
// ============================
function renderEscala(){
  var f=formEscala;
  var doMes=escala.filter(function(e){return parseInt(e.mes)===escalaMesFiltro;});
  var eventos=[],eventoKeys={};
  doMes.forEach(function(e){var k=e.data+"||"+e.culto;if(!eventoKeys[k]){eventoKeys[k]=true;eventos.push({data:e.data,culto:e.culto});}});
  eventos.sort(function(a,b){return a.data.localeCompare(b.data);});
  var html='<h2 class="section-title">Escala do Minist√©rio</h2>';
  if(isEditor){
    html+='<div class="form-box">'+
      '<div class="form-group"><label>Data *</label><input type="date" value="'+esc(f.data)+'" onchange="formEscala.data=this.value" /></div>'+
      '<div class="form-group"><label>M√™s da Escala *</label><select onchange="formEscala.mes=parseInt(this.value)">'+
        MESES.map(function(m,i){return'<option value="'+i+'"'+(f.mes===i?" selected":"")+'>'+m+'</option>';}).join("")+
      '</select></div>'+
      '<div class="form-group"><label>Culto *</label><select onchange="formEscala.culto=this.value"><option value="">Selecionar...</option>'+
        CULTOS.map(function(c){return'<option value="'+c+'"'+(f.culto===c?" selected":"")+'>'+c+'</option>';}).join("")+
      '</select></div>'+
      '<div class="form-group"><label>Fun√ß√£o *</label><select onchange="formEscala.funcao=this.value"><option value="">Selecionar...</option>'+
        FUNCOES.map(function(fn){return'<option value="'+fn+'"'+(f.funcao===fn?" selected":"")+'>'+fn+'</option>';}).join("")+
      '</select></div>'+
      '<div class="form-group"><label>Nome *</label><input type="text" value="'+esc(f.nome)+'" oninput="formEscala.nome=this.value" placeholder="Nome do membro" /></div>'+
      '<div class="form-group"><label>Obs</label><input type="text" value="'+esc(f.obs)+'" oninput="formEscala.obs=this.value" placeholder="Observa√ß√µes" /></div>'+
    '</div>'+
    '<div class="form-actions no-print">'+
      '<button class="btn-primary" onclick="saveEscala()">'+(editIndex!==null?"‚úèÔ∏è Atualizar":"‚ûï Adicionar")+'</button>'+
      (editIndex!==null?'<button class="btn-secondary" onclick="cancelEscala()">Cancelar</button>':"")+
    '</div>';
  }
  html+='<div class="escala-controls no-print">'+
    '<label style="font-size:13px;font-weight:600;color:var(--text-soft)">Visualizar m√™s:</label>'+
    '<select onchange="escalaMesFiltro=parseInt(this.value);render()">'+
      MESES.map(function(m,i){return'<option value="'+i+'"'+(escalaMesFiltro===i?" selected":"")+'>'+m+'</option>';}).join("")+
    '</select>'+
    '<button class="btn-green" onclick="window.print()">üñ®Ô∏è Imprimir / Salvar PDF</button>'+
  '</div>';
  html+='<div class="print-wrap">';
  if(eventos.length===0){html+='<div class="empty">Nenhuma escala para '+MESES[escalaMesFiltro]+' ainda.</div>';}
  else{
    html+='<table class="print-table"><thead><tr><th class="func-col">'+MESES[escalaMesFiltro]+'</th>'+
      eventos.map(function(ev){return'<th><div>'+esc(ev.culto)+'</div><div style="font-weight:400;opacity:.85;font-size:10px">'+fmtDate(ev.data)+'</div></th>';}).join("")+
    '</tr></thead><tbody>'+
      FUNCOES.map(function(fn){
        var cells=eventos.map(function(ev){
          var entry=doMes.find(function(e){return e.funcao===fn&&e.data===ev.data&&e.culto===ev.culto;});
          return'<td>'+(entry?esc(entry.nome):"")+'</td>';
        }).join("");
        return'<tr><td class="func-name">'+fn+'</td>'+cells+'</tr>';
      }).join("")+
    '</tbody></table>';
  }
  html+='</div>';
  if(isEditor&&escala.length>0){
    html+='<div class="no-print" style="margin-top:24px"><h3 style="font-size:14px;font-weight:700;color:var(--text-soft);margin-bottom:10px">TODOS OS REGISTROS</h3>'+
      '<table class="table"><thead><tr><th>Data</th><th>M√™s</th><th>Culto</th><th>Fun√ß√£o</th><th>Nome</th><th>Obs</th><th></th></tr></thead><tbody>'+
      escala.map(function(e,i){
        return'<tr><td>'+fmtDate(e.data)+'</td><td>'+(MESES[parseInt(e.mes)]||"")+'</td><td><span class="badge">'+esc(e.culto)+'</span></td><td>'+esc(e.funcao)+'</td><td><strong>'+esc(e.nome)+'</strong></td><td>'+esc(e.obs)+'</td>'+
          '<td><button class="icon-btn" onclick="editEscala('+i+')">‚úèÔ∏è</button><button class="icon-btn" onclick="delEscala('+i+')">üóëÔ∏è</button></td></tr>';
      }).join("")+
    '</tbody></table></div>';
  }
  return html;
}
function saveEscala(){
  var f=formEscala;
  if(!f.nome.trim()){alert("Preencha o nome.");return;}
  if(!f.culto){alert("Selecione o culto.");return;}
  if(!f.funcao){alert("Selecione a fun√ß√£o.");return;}
  if(!f.data){alert("Selecione a data.");return;}
  var arr=escala.slice();
  if(editIndex!==null){arr[editIndex]=Object.assign({},f);editIndex=null;}else arr.push(Object.assign({},f));
  arr.sort(function(a,b){return(a.data||"").localeCompare(b.data||"");});
  saveData("escala",arr);
  var ms=f.mes,ds=f.data,cs=f.culto;
  formEscala=emptyEscala();formEscala.mes=ms;formEscala.data=ds;formEscala.culto=cs;
  escalaMesFiltro=ms;
}
function cancelEscala(){editIndex=null;formEscala=emptyEscala();render();}
function editEscala(i){formEscala=Object.assign({},escala[i],{mes:parseInt(escala[i].mes)||0});editIndex=i;escalaMesFiltro=formEscala.mes;window.scrollTo(0,0);render();}
function delEscala(i){if(confirm("Remover?")){ var arr=escala.slice();arr.splice(i,1);saveData("escala",arr);}}

// ============================
// LOUVORES
// ============================
function renderLouvores(){
  var f=formLouvor;
  var filtrados=louvores.filter(function(l){
    var q=buscaLouvor.toLowerCase();
    return(l.titulo||"").toLowerCase().includes(q)||(l.artista||"").toLowerCase().includes(q)||
           (l.obs||"").toLowerCase().includes(q)||(l.nota||"").toLowerCase().includes(q)||(l.trecho||"").toLowerCase().includes(q);
  });
  var html='<h2 class="section-title">Lista de Louvores</h2>';
  if(isEditor){
    html+='<div class="form-box">'+
      '<div class="form-group full"><label>T√≠tulo *</label><input placeholder="Nome do louvor" value="'+esc(f.titulo)+'" oninput="formLouvor.titulo=this.value" /></div>'+
      '<div class="form-group"><label>Artista / Banda</label><input placeholder="Ex: Hillsong" value="'+esc(f.artista)+'" oninput="formLouvor.artista=this.value" /></div>'+
      '<div class="form-group"><label>Tom</label><select onchange="formLouvor.nota=this.value"><option value="">Selecionar...</option>'+
        NOTAS.map(function(n){return'<option value="'+n+'"'+(f.nota===n?" selected":"")+'>'+n+'</option>';}).join("")+
      '</select></div>'+
      '<div class="form-group"><label>BPM (andamento)</label><input type="number" min="40" max="250" placeholder="Ex: 80" value="'+esc(f.bpm)+'" oninput="formLouvor.bpm=this.value" /></div>'+
      '<div class="form-group"><label>Link (YouTube/Drive)</label><input placeholder="https://..." value="'+esc(f.link)+'" oninput="formLouvor.link=this.value" /></div>'+
      '<div class="form-group full"><label>Trecho / Letra</label><textarea rows="3" placeholder="Cole aqui um trecho da letra para facilitar a busca..." oninput="formLouvor.trecho=this.value">'+esc(f.trecho||"")+'</textarea></div>'+
    '</div>'+
    '<div class="form-actions">'+
      '<button class="btn-primary" onclick="saveLouvor()">'+(editIndex!==null?"‚úèÔ∏è Atualizar":"‚ûï Adicionar")+'</button>'+
      (editIndex!==null?'<button class="btn-secondary" onclick="editIndex=null;formLouvor=emptyLouvor();render()">Cancelar</button>':"")+
    '</div>';
  }
  html+='<div style="position:relative;margin-top:16px">'+
    '<input class="search-input" style="margin-top:0;padding-right:52px" placeholder="Buscar por nome, artista, tom, trecho da letra..." value="'+esc(buscaLouvor)+'" oninput="buscaLouvor=this.value;render()" id="search-louvor"/>'+
    '<button onclick="startVoiceSearch()" title="Busca por voz" id="btn-voice" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:6px 8px;border-radius:8px;display:flex;align-items:center;justify-content:center;gap:2px;height:36px;" onmouseover="this.style.background=\'var(--surface2)\'" onmouseout="this.style.background=\'none\'">'+
      '<span class="voice-bar" style="height:6px"></span><span class="voice-bar" style="height:12px"></span><span class="voice-bar" style="height:18px"></span><span class="voice-bar" style="height:12px"></span><span class="voice-bar" style="height:6px"></span>'+
    '</button>'+
  '</div>';
  if(filtrados.length===0){html+='<div class="empty">Nenhum louvor encontrado.</div>';}
  else{
    html+='<div class="cards-grid">'+
      filtrados.map(function(l){
        var i=louvores.indexOf(l),ytId=getYoutubeId(l.link);
        return'<div class="card">'+
          '<div class="card-header"><span class="card-title">'+esc(l.titulo)+'</span>'+
            '<div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end">'+
              (l.nota?'<span class="badge badge-green">Tom: '+esc(l.nota)+'</span>':"")+
              (l.bpm?'<span class="badge badge-blue">'+esc(l.bpm)+' BPM</span>':"")+
            '</div>'+
          '</div>'+
          (l.artista?'<div class="card-sub">'+esc(l.artista)+'</div>':"")+
          '<div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">'+
            ((l.link||ytId)?'<button onclick="togglePreview(this,\''+(ytId||"")+'\',\''+esc(l.link||"")+'\''+')" style="background:var(--primary);border:none;color:white;font-size:12px;font-weight:600;cursor:pointer;padding:5px 12px;border-radius:6px">‚ñ∂ Ouvir / Ver</button>':"" )+
            (l.bpm?'<button onclick="setMetroBPM('+l.bpm+')" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:12px;cursor:pointer;padding:5px 10px;border-radius:6px">ü•Å Click</button>':"")+
            '<a href="https://www.google.com/search?q='+encodeURIComponent("cifra "+(l.titulo||"")+" "+(l.artista||"")+" site:cifraclub.com.br")+'" target="_blank" class="card-link">üé∏ Cifra</a>'+
            '<a href="https://www.google.com/search?q='+encodeURIComponent("letra "+(l.titulo||"")+" "+(l.artista||"")+" site:letras.mus.br")+'" target="_blank" class="card-link">üìù Letra</a>'+
          '</div>'+
          '<div class="yt-preview" style="display:none;margin-top:8px"></div>'+
          (isEditor?'<div class="card-actions"><button class="icon-btn" onclick="editLouvor('+i+')">‚úèÔ∏è</button><button class="icon-btn" onclick="delLouvor('+i+')">üóëÔ∏è</button></div>':"" )+
        '</div>';
      }).join("")+
    '</div>';
  }
  return html;
}
function saveLouvor(){
  if(!formLouvor.titulo.trim()){alert("Preencha o t√≠tulo.");return;}
  var arr=louvores.slice();
  if(editIndex!==null){arr[editIndex]=Object.assign({},formLouvor);editIndex=null;}else arr.push(Object.assign({},formLouvor));
  arr.sort(function(a,b){return(a.titulo||"").localeCompare(b.titulo||"");});
  saveData("louvores",arr);formLouvor=emptyLouvor();
}
function editLouvor(i){formLouvor=Object.assign({},louvores[i]);editIndex=i;window.scrollTo(0,0);render();}
function delLouvor(i){if(confirm("Remover?")){var arr=louvores.slice();arr.splice(i,1);saveData("louvores",arr);}}

// ============================
// ANIVERSARIANTES
// ============================
function renderAniversariantes(){
  var f=formAniv,hoje=new Date(),mesAtual=hoje.getMonth()+1;
  var html='<h2 class="section-title">Aniversariantes</h2>';
  if(isEditor){
    html+='<div class="form-box">'+
      '<div class="form-group full"><label>Nome *</label><input placeholder="Nome completo" value="'+esc(f.nome)+'" oninput="formAniv.nome=this.value" /></div>'+
      '<div class="form-group"><label>Dia *</label><input type="number" min="1" max="31" placeholder="Ex: 15" value="'+esc(f.dia)+'" oninput="formAniv.dia=this.value" /></div>'+
      '<div class="form-group"><label>M√™s *</label><select onchange="formAniv.mes=this.value"><option value="">M√™s...</option>'+
        MESES.map(function(m,i){return'<option value="'+(i+1)+'"'+(f.mes==i+1?" selected":"")+'>' + m+'</option>';}).join("")+
      '</select></div>'+
      '<div class="form-group"><label>Fun√ß√£o</label><input placeholder="Ex: Vocal" value="'+esc(f.funcao)+'" oninput="formAniv.funcao=this.value" /></div>'+
      '<div class="form-group"><label>Telefone</label><input placeholder="(99) 99999-9999" value="'+esc(f.tel)+'" oninput="formAniv.tel=this.value" /></div>'+
    '</div>'+
    '<div class="form-actions">'+
      '<button class="btn-primary" onclick="saveAniv()">'+(editIndex!==null?"‚úèÔ∏è Atualizar":"‚ûï Adicionar")+'</button>'+
      (editIndex!==null?'<button class="btn-secondary" onclick="editIndex=null;formAniv={nome:\'\',dia:\'\',mes:\'\',funcao:\'\',tel:\'\'};render()">Cancelar</button>':"")+
    '</div>';
  }
  if(aniversariantes.length===0){html+='<div class="empty">Nenhum aniversariante cadastrado.</div>';}
  else{
    MESES.forEach(function(mes,mi){
      var doMes=aniversariantes.filter(function(a){return parseInt(a.mes)===mi+1;});
      if(!doMes.length)return;
      html+='<h3 class="mes-header '+(mi+1===mesAtual?"mes-atual":"")+'">'+mes+(mi+1===mesAtual?" üéâ":"")+'</h3>'+
        '<table class="table"><thead><tr><th>Dia</th><th>Nome</th><th>Fun√ß√£o</th><th>Telefone</th>'+(isEditor?"<th></th>":"")+'</tr></thead><tbody>'+
        doMes.map(function(a){
          var i=aniversariantes.indexOf(a),d=mi+1===mesAtual&&parseInt(a.dia)===hoje.getDate();
          return'<tr class="'+(d?"row-destaque":"")+'"><td><strong>'+String(a.dia).padStart(2,"0")+'</strong></td><td>'+esc(a.nome)+'</td>'+
            '<td><span class="badge">'+esc(a.funcao)+'</span></td><td>'+esc(a.tel)+'</td>'+
            (isEditor?'<td><button class="icon-btn" onclick="editAniv('+i+')">‚úèÔ∏è</button><button class="icon-btn" onclick="delAniv('+i+')">üóëÔ∏è</button></td>':"")+
          '</tr>';
        }).join("")+
      '</tbody></table>';
    });
  }
  return html;
}
function saveAniv(){
  if(!formAniv.nome.trim()||!formAniv.dia||!formAniv.mes){alert("Preencha nome, dia e m√™s.");return;}
  var arr=aniversariantes.slice();
  if(editIndex!==null){arr[editIndex]=Object.assign({},formAniv);editIndex=null;}else arr.push(Object.assign({},formAniv));
  arr.sort(function(a,b){return(parseInt(a.mes)*100+parseInt(a.dia))-(parseInt(b.mes)*100+parseInt(b.dia));});
  saveData("aniversariantes",arr);formAniv={nome:"",dia:"",mes:"",funcao:"",tel:""};
}
function editAniv(i){formAniv=Object.assign({},aniversariantes[i]);editIndex=i;window.scrollTo(0,0);render();}
function delAniv(i){if(confirm("Remover?")){var arr=aniversariantes.slice();arr.splice(i,1);saveData("aniversariantes",arr);}}

// ============================
// CRONOGRAMA
// ============================
function renderCronograma(){
  var f=formCron;
  var html='<h2 class="section-title">Cronograma de Atividades</h2>';
  if(isEditor){
    html+='<div class="form-box">'+
      '<div class="form-group"><label>Data</label><input type="date" value="'+esc(f.data)+'" onchange="formCron.data=this.value" /></div>'+
      '<div class="form-group full"><label>T√≠tulo *</label><input placeholder="Nome da atividade" value="'+esc(f.titulo)+'" oninput="formCron.titulo=this.value" /></div>'+
      '<div class="form-group"><label>Respons√°vel</label><input placeholder="Quem vai fazer" value="'+esc(f.responsavel)+'" oninput="formCron.responsavel=this.value" /></div>'+
      '<div class="form-group"><label>Status</label><select onchange="formCron.status=this.value">'+
        Object.entries(STATUS_LABELS).map(function(e){return'<option value="'+e[0]+'"'+(f.status===e[0]?" selected":"")+'>'+e[1]+'</option>';}).join("")+
      '</select></div>'+
      '<div class="form-group full"><label>Descri√ß√£o</label><textarea rows="2" oninput="formCron.descricao=this.value">'+esc(f.descricao)+'</textarea></div>'+
    '</div>'+
    '<div class="form-actions">'+
      '<button class="btn-primary" onclick="saveCron()">'+(editIndex!==null?"‚úèÔ∏è Atualizar":"‚ûï Adicionar")+'</button>'+
      (editIndex!==null?'<button class="btn-secondary" onclick="editIndex=null;formCron={data:\'\',titulo:\'\',descricao:\'\',responsavel:\'\',status:\'pendente\'};render()">Cancelar</button>':"")+
    '</div>';
  }
  if(cronograma.length===0){html+='<div class="empty">Nenhuma atividade no cronograma.</div>';}
  else{
    html+='<table class="table"><thead><tr><th>Data</th><th>Atividade</th><th>Respons√°vel</th><th>Status</th>'+(isEditor?"<th></th>":"")+'</tr></thead><tbody>'+
      cronograma.map(function(c,i){
        return'<tr style="opacity:'+(c.status==="cancelado"?"0.5":"1")+'">'+
          '<td>'+(c.data?fmtDate(c.data):"‚Äî")+'</td>'+
          '<td><strong>'+esc(c.titulo)+'</strong>'+(c.descricao?'<div style="font-size:12px;color:var(--text-soft);margin-top:2px">'+esc(c.descricao)+'</div>':"")+
          '</td><td>'+esc(c.responsavel)+'</td>'+
          '<td>'+(isEditor?'<button class="status-btn" onclick="toggleStatus('+i+')">'+STATUS_LABELS[c.status||"pendente"]+'</button>':STATUS_LABELS[c.status||"pendente"])+'</td>'+
          (isEditor?'<td><button class="icon-btn" onclick="editCron('+i+')">‚úèÔ∏è</button><button class="icon-btn" onclick="delCron('+i+')">üóëÔ∏è</button></td>':"")+
        '</tr>';
      }).join("")+
    '</tbody></table>';
  }
  return html;
}
function saveCron(){
  if(!formCron.titulo.trim()){alert("Preencha o t√≠tulo.");return;}
  var arr=cronograma.slice();
  if(editIndex!==null){arr[editIndex]=Object.assign({},formCron);editIndex=null;}else arr.push(Object.assign({},formCron));
  arr.sort(function(a,b){return(a.data||"").localeCompare(b.data||"");});
  saveData("cronograma",arr);formCron={data:"",titulo:"",descricao:"",responsavel:"",status:"pendente"};
}
function toggleStatus(i){
  var order=["pendente","concluido","cancelado"],arr=cronograma.slice();
  arr[i]=Object.assign({},arr[i],{status:order[(order.indexOf(arr[i].status||"pendente")+1)%order.length]});
  saveData("cronograma",arr);
}
function editCron(i){formCron=Object.assign({},cronograma[i]);editIndex=i;window.scrollTo(0,0);render();}
function delCron(i){if(confirm("Remover?")){var arr=cronograma.slice();arr.splice(i,1);saveData("cronograma",arr);}}

// ============================
// REGRAS
// ============================
function renderRegras(){
  var f=formRegra;
  var html='<h2 class="section-title">Regras do Minist√©rio</h2>';
  if(isEditor){
    html+='<div class="form-box">'+
      '<div class="form-group full"><label>T√≠tulo da Regra *</label><input placeholder="Ex: Pontualidade" value="'+esc(f.titulo)+'" oninput="formRegra.titulo=this.value" /></div>'+
      '<div class="form-group full"><label>Descri√ß√£o / Detalhamento</label><textarea rows="3" oninput="formRegra.descricao=this.value">'+esc(f.descricao)+'</textarea></div>'+
    '</div>'+
    '<div class="form-actions">'+
      '<button class="btn-primary" onclick="saveRegra()">'+(editIndex!==null?"‚úèÔ∏è Atualizar":"‚ûï Adicionar Regra")+'</button>'+
      (editIndex!==null?'<button class="btn-secondary" onclick="editIndex=null;formRegra={titulo:\'\',descricao:\'\'};render()">Cancelar</button>':"")+
    '</div>';
  }
  if(regras.length===0){html+='<div class="empty">Nenhuma regra cadastrada ainda.</div>';}
  else{
    html+='<div class="regras-list">'+
      regras.map(function(r,i){
        return'<div class="regra-card">'+
          '<div class="regra-num">'+(i+1)+'</div>'+
          '<div class="regra-body"><div class="regra-titulo">'+esc(r.titulo)+'</div>'+(r.descricao?'<div class="regra-desc">'+esc(r.descricao)+'</div>':"")+
          '</div>'+
          (isEditor?'<div class="regra-actions">'+
            '<button class="icon-btn" onclick="moveRegra('+i+',-1)">‚¨ÜÔ∏è</button>'+
            '<button class="icon-btn" onclick="moveRegra('+i+',1)">‚¨áÔ∏è</button>'+
            '<button class="icon-btn" onclick="editRegra('+i+')">‚úèÔ∏è</button>'+
            '<button class="icon-btn" onclick="delRegra('+i+')">üóëÔ∏è</button></div>':"")+
        '</div>';
      }).join("")+
    '</div>';
  }
  return html;
}
function saveRegra(){
  if(!formRegra.titulo.trim()){alert("Preencha o t√≠tulo.");return;}
  var arr=regras.slice();
  if(editIndex!==null){arr[editIndex]=Object.assign({},formRegra);editIndex=null;}else arr.push(Object.assign({},formRegra));
  saveData("regras",arr);formRegra={titulo:"",descricao:""};
}
function moveRegra(i,dir){var arr=regras.slice(),j=i+dir;if(j<0||j>=arr.length)return;var tmp=arr[i];arr[i]=arr[j];arr[j]=tmp;saveData("regras",arr);}
function editRegra(i){formRegra=Object.assign({},regras[i]);editIndex=i;window.scrollTo(0,0);render();}
function delRegra(i){if(confirm("Remover?")){var arr=regras.slice();arr.splice(i,1);saveData("regras",arr);}}

// ============================
// FERRAMENTAS
// ============================
const CHROMATIC=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const FLAT_TO_SHARP={"Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#","Cb":"B","Fb":"E"};
function noteIndex(n){n=FLAT_TO_SHARP[n]||n;return CHROMATIC.indexOf(n);}
function transposeNote(note,st){
  var base=note.replace(/m|maj|dim|aug|sus\d?|add\d?|[0-9]|\/.*/g,"");
  var suffix=note.slice(base.length);
  var norm=FLAT_TO_SHARP[base]||base;
  var idx=CHROMATIC.indexOf(norm);if(idx===-1)return note;
  return CHROMATIC[(idx+st+12)%12]+suffix;
}
function transposeChords(texto,st){
  return texto.replace(/\b([A-G][#b]?(?:m|maj|dim|aug|sus\d?|add\d?)?(?:[0-9]+)?(?:\/[A-G][#b]?)?)\b/g,function(match){
    var sl=match.indexOf("/");
    if(sl!==-1)return transposeNote(match.slice(0,sl),st)+"/"+transposeNote(match.slice(sl+1),st);
    return transposeNote(match,st);
  });
}

function renderFerramentas(){
  var tools=[["transpositor","üéº Transpositor"],["medley","üé∂ Sequ√™ncia / Medley"],["vozes","üé§ Divis√£o de Vozes"],["metronomo","ü•Å Metr√¥nomo"]];
  var html='<h2 class="section-title">üé∏ Ferramentas Musicais</h2>';
  html+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px">'+
    tools.map(function(t){
      var a=ferraTab===t[0];
      return'<button onclick="ferraTab=\''+t[0]+'\';transResult=null;medleyResult=null;vozResult=null;render()" '+
        'style="padding:9px 18px;border-radius:20px;border:2px solid var(--primary);font-size:13px;font-weight:600;cursor:pointer;background:'+(a?"var(--primary)":"var(--surface)")+';color:'+(a?"white":"var(--primary)")+'">'+ t[1]+'</button>';
    }).join("")+
  '</div>';
  if(ferraTab==="transpositor") html+=renderTranspositor();
  if(ferraTab==="medley")       html+=renderMedley();
  if(ferraTab==="vozes")        html+=renderVozes();
  if(ferraTab==="metronomo")    html+=renderMetronomo();
  return html;
}

// --- TRANSPOSITOR ---
function renderTranspositor(){
  var html='<div style="background:var(--surface);border-radius:14px;padding:20px;box-shadow:var(--card-shadow)">'+
    '<p style="font-size:13px;color:var(--text-soft);margin-bottom:16px">Transponha qualquer louvor para outro tom. Cole a cifra e veja os acordes convertidos automaticamente.</p>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">'+
      '<div class="form-group"><label>Tom Original</label><select onchange="transOrigem=this.value"><option value="">Selecionar...</option>'+
        CHROMATIC.map(function(n){return'<option value="'+n+'"'+(transOrigem===n?" selected":"")+'>'+n+'</option>';}).join("")+
      '</select></div>'+
      '<div class="form-group"><label>Tom Destino</label><select onchange="transDestino=this.value"><option value="">Selecionar...</option>'+
        CHROMATIC.map(function(n){return'<option value="'+n+'"'+(transDestino===n?" selected":"")+'>'+n+'</option>';}).join("")+
      '</select></div>'+
    '</div>'+
    '<div class="form-group" style="margin-bottom:12px"><label>Cole a cifra aqui (opcional)</label>'+
      '<textarea rows="6" placeholder="Ex:&#10;C  Am  F  G&#10;Na tua presen√ßa..." oninput="transCifra=this.value" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:monospace;background:var(--input-bg);color:var(--text);outline:none">'+esc(transCifra)+'</textarea></div>'+
    '<button onclick="calcTranspositor()" class="btn-primary">üéº Transpor</button>'+
  '</div>';
  if(transResult){
    html+='<div style="background:var(--surface);border-radius:14px;padding:20px;margin-top:16px;box-shadow:var(--card-shadow)">'+
      '<h3 style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:12px">'+transResult.origem+' ‚Üí '+transResult.destino+' ('+(transResult.semitones>0?"+":"")+transResult.semitones+' semiton'+(Math.abs(transResult.semitones)!==1?"s":"")+')</h3>'+
      '<p style="font-size:12px;font-weight:600;color:var(--text-soft);margin-bottom:8px">TABELA DE ACORDES</p>'+
      '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">'+
        transResult.tabela.map(function(t){
          return'<div style="background:var(--primary-bg);border-radius:8px;padding:6px 12px;font-size:13px;text-align:center">'+
            '<span style="color:var(--text-soft);font-size:11px">'+t.de+'</span><br><strong style="color:var(--primary)">'+t.para+'</strong></div>';
        }).join("")+
      '</div>'+
      (transResult.cifraTransposta?'<p style="font-size:12px;font-weight:600;color:var(--text-soft);margin-bottom:8px">CIFRA TRANSPOSTA</p>'+
        '<pre style="background:var(--surface2);border-radius:8px;padding:14px;font-size:13px;font-family:monospace;color:var(--text);overflow-x:auto;white-space:pre-wrap">'+esc(transResult.cifraTransposta)+'</pre>':"")+
    '</div>';
  }
  return html;
}
function calcTranspositor(){
  if(!transOrigem||!transDestino){alert("Selecione os tons.");return;}
  var st=(noteIndex(transDestino)-noteIndex(transOrigem)+12)%12;
  if(st>6)st-=12;
  var graus=[0,2,4,5,7,9,11];
  var tabela=graus.map(function(g){
    var orig=CHROMATIC[(noteIndex(transOrigem)+g+12)%12];
    var dest=CHROMATIC[(noteIndex(transOrigem)+g+st+12)%12];
    return{de:orig,para:dest};
  });
  [0,2,5,7,9].forEach(function(g){
    tabela.push({de:CHROMATIC[(noteIndex(transOrigem)+g+12)%12]+"m",para:CHROMATIC[(noteIndex(transOrigem)+g+st+12)%12]+"m"});
  });
  transResult={origem:transOrigem,destino:transDestino,semitones:st,tabela:tabela,cifraTransposta:transCifra?transposeChords(transCifra,st):null};
  render();
}

// --- MEDLEY / SEQU√äNCIA (com l√≥gica de transposi√ß√£o por proximidade de tons) ---
function renderMedley(){
  var tipos=[
    {v:"agitado",l:"üî• Mais agitados / animados"},
    {v:"adoracao",l:"üïäÔ∏è Somente adora√ß√£o / lentos"},
    {v:"misto",l:"üéµ Misturado (agitado ‚Üí adora√ß√£o)"},
    {v:"vigilia",l:"üåô Vig√≠lia / ora√ß√£o"},
    {v:"mulheres",l:"üå∏ Culto de Mulheres"}
  ];
  var html='<div style="background:var(--surface);border-radius:14px;padding:20px;box-shadow:var(--card-shadow);margin-bottom:16px">'+
    '<p style="font-size:13px;color:var(--text-soft);margin-bottom:4px">Monte uma sequ√™ncia com os louvores cadastrados.</p>'+
    '<p style="font-size:12px;color:var(--primary);margin-bottom:16px">üéØ A sequ√™ncia leva em conta a proximidade dos tons para facilitar as transi√ß√µes ao vivo!</p>'+
    '<div class="form-group" style="margin-bottom:12px"><label>Tipo de sequ√™ncia</label><select onchange="medleyTipo=this.value">'+
      tipos.map(function(t){return'<option value="'+t.v+'"'+(medleyTipo===t.v?" selected":"")+'>'+t.l+'</option>';}).join("")+
    '</select></div>'+
    '<button onclick="calcMedley()" class="btn-primary">üé∂ Montar Sequ√™ncia</button>'+
  '</div>';

  if(medleyResult){
    html+='<div style="background:var(--surface);border-radius:14px;padding:20px;box-shadow:var(--card-shadow)">'+
      '<h3 style="font-size:15px;font-weight:700;margin-bottom:4px;color:var(--text)">'+medleyResult.titulo+'</h3>'+
      '<p style="font-size:12px;color:var(--text-soft);margin-bottom:16px">'+medleyResult.descricao+'</p>'+
      medleyResult.sequencia.map(function(item,i){
        var proxTom=i<medleyResult.sequencia.length-1?medleyResult.sequencia[i+1].nota:"";
        var dist=toneDistance(item.nota,proxTom);
        var trans=i<medleyResult.sequencia.length-1?(dist===0?"‚Üí Mesmo tom, sem transposi√ß√£o":(dist<=2?"‚Üí "+proxTom+" (transi√ß√£o f√°cil, "+dist+" semitom"+(dist>1?"s":"")+")"  :"‚Üí "+proxTom+" (aten√ß√£o: "+dist+" semitons)")):"";
        var corTrans=dist===0?"#059669":dist<=2?"#2563eb":"#dc2626";
        return'<div style="display:flex;gap:14px;align-items:flex-start;padding:14px 0;border-bottom:1px solid var(--border)">'+
          '<div style="background:var(--primary);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0">'+(i+1)+'</div>'+
          '<div style="flex:1">'+
            '<div style="font-weight:700;font-size:14px;color:var(--text)">'+esc(item.titulo)+'</div>'+
            (item.artista?'<div style="font-size:12px;color:var(--text-muted)">'+esc(item.artista)+'</div>':"")+
            '<div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center">'+
              (item.nota?'<span class="badge badge-green">Tom: '+item.nota+'</span>':"")+
              (item.bpm?'<span class="badge badge-blue">'+item.bpm+' BPM</span>':"")+
              (trans?'<span style="font-size:11px;color:'+corTrans+';font-weight:600">'+trans+'</span>':"")+
            '</div>'+
            '<div style="font-size:12px;color:var(--text-soft);margin-top:4px">'+item.dica+'</div>'+
          '</div>'+
        '</div>';
      }).join("")+
      '<div style="margin-top:16px;background:var(--primary-bg);border-radius:8px;padding:12px;font-size:13px;color:var(--text)">'+medleyResult.dica_geral+'</div>'+
    '</div>';
  }
  return html;
}
function calcMedley(){
  if(louvores.length===0){alert("Nenhum louvor cadastrado ainda!");return;}
  var lista=louvores.slice();
  var titulo,descricao,dica_geral,dicas;

  var cfgs={
    agitado:{titulo:"üî• Sequ√™ncia Agitada",descricao:"Ordenada por proximidade de tons para transi√ß√µes suaves.",dica_geral:"üí° Mantenha o BPM alto. Fa√ßa transi√ß√µes r√°pidas sem parar. Tons pr√≥ximos = menos reapina√ß√£o!",dicas:["Abra com tudo! Tom de entrada.","Mesma energia, transi√ß√£o suave.","Mant√©m o ritmo, varia o estilo.","Come√ßa a desacelerar um pouco.","Fecha a fase agitada aqui."]},
    adoracao:{titulo:"üïäÔ∏è Sequ√™ncia de Adora√ß√£o",descricao:"Progress√£o suave entre tons pr√≥ximos para adora√ß√£o cont√≠nua.",dica_geral:"üí° Reduza o volume gradualmente. Deixe espa√ßos. Tons pr√≥ximos permitem modular sem quebrar o momento.",dicas:["Convide √† adora√ß√£o com suavidade.","Aprofunde o momento espiritual.","V√° para algo mais √≠ntimo.","Reduza a din√¢mica ao m√°ximo.","Silence e ora√ß√£o."]},
    misto:{titulo:"üéµ Sequ√™ncia Mista",descricao:"Come√ßa agitado e termina em adora√ß√£o, com transi√ß√µes cuidadosas.",dica_geral:"üí° Sobe a energia e desce suavemente. Os tons foram escolhidos para facilitar a transi√ß√£o entre os momentos.",dicas:["Celebra√ß√£o ‚Äî energia total!","Mant√©m a anima√ß√£o.","Come√ßa a transi√ß√£o.","Momento mais reflexivo.","Adora√ß√£o profunda."]},
    vigilia:{titulo:"üåô Sequ√™ncia para Vig√≠lia",descricao:"Tons compat√≠veis para uma noite de clamor e adora√ß√£o.",dica_geral:"üí° Alterne clamor e adora√ß√£o. Com tons pr√≥ximos, voc√™ pode medleyar sem parar.",dicas:["Clamor de abertura.","Adora√ß√£o √≠ntima.","Intercess√£o musical.","Espera no Senhor.","Encerramento."]},
    mulheres:{titulo:"üå∏ Culto de Mulheres",descricao:"Sele√ß√£o acolhedora com progress√£o harm√¥nica suave.",dica_geral:"üí° Valorize as vozes femininas. Tons pr√≥ximos facilitam a transi√ß√£o sem quebrar a atmosfera.",dicas:["Boas-vindas musicais.","Louvor expressivo.","Adora√ß√£o profunda.","Ministra√ß√£o suave.","Encerramento com gra√ßa."]}
  };
  var cfg=cfgs[medleyTipo];

  // Ordenar por proximidade de tons (greedy nearest neighbor)
  var disponivel=lista.slice();
  var ordenado=[];
  // Come√ßa com qualquer (primeiro da lista)
  ordenado.push(disponivel.splice(0,1)[0]);
  while(disponivel.length>0){
    var ultimo=ordenado[ordenado.length-1];
    var melhorIdx=0, melhorDist=99;
    for(var i=0;i<disponivel.length;i++){
      var d=toneDistance(ultimo.nota,disponivel[i].nota);
      if(d<melhorDist){melhorDist=d;melhorIdx=i;}
    }
    ordenado.push(disponivel.splice(melhorIdx,1)[0]);
  }

  var total=Math.min(ordenado.length,6);
  var sequencia=ordenado.slice(0,total).map(function(l,i){
    return{titulo:l.titulo,artista:l.artista,nota:l.nota,bpm:l.bpm,dica:cfg.dicas[Math.min(i,cfg.dicas.length-1)]};
  });
  medleyResult={titulo:cfg.titulo,descricao:cfg.descricao,sequencia:sequencia,dica_geral:cfg.dica_geral};
  render();
}

// --- DIVIS√ÉO DE VOZES ---
function renderVozes(){
  var html='<div style="background:var(--surface);border-radius:14px;padding:20px;box-shadow:var(--card-shadow);margin-bottom:16px">'+
    '<p style="font-size:13px;color:var(--text-soft);margin-bottom:16px">Veja como dividir as vozes do back vocal para um louvor cadastrado.</p>'+
    '<div class="form-group" style="margin-bottom:12px"><label>Escolha o louvor</label>'+
      '<select onchange="vozLouvor=this.value"><option value="">Selecionar...</option>'+
        louvores.map(function(l){return'<option value="'+esc(l.titulo)+'"'+(vozLouvor===l.titulo?" selected":"")+'>'+esc(l.titulo)+(l.nota?" (Tom: "+l.nota+")":"")+'</option>';}).join("")+
      '</select></div>'+
    '<button onclick="calcVozes()" class="btn-primary">üé§ Ver Divis√£o de Vozes</button>'+
  '</div>';
  if(vozResult){
    var vozes=[
      {nome:"Soprano",emoji:"üéµ",cor:"#e11d48",desc:vozResult.soprano},
      {nome:"Contralto",emoji:"üé∂",cor:"#7c3aed",desc:vozResult.contralto},
      {nome:"Tenor",emoji:"üéº",cor:"#2563eb",desc:vozResult.tenor},
      {nome:"Falsete",emoji:"‚ú®",cor:"#0891b2",desc:vozResult.falsete},
      {nome:"2¬™ Voz",emoji:"üé§",cor:"#059669",desc:vozResult.segunda}
    ];
    html+='<div style="background:var(--surface);border-radius:14px;padding:20px;box-shadow:var(--card-shadow)">'+
      '<h3 style="font-size:15px;font-weight:700;margin-bottom:4px;color:var(--text)">'+esc(vozResult.louvor)+'</h3>'+
      (vozResult.tom?'<p style="font-size:12px;color:var(--text-soft);margin-bottom:16px">Tom: '+vozResult.tom+'</p>':'<div style="margin-bottom:16px"></div>')+
      vozes.map(function(v){
        return'<div style="display:flex;gap:14px;padding:14px;background:var(--surface2);border-radius:10px;margin-bottom:10px">'+
          '<div style="width:36px;height:36px;border-radius:50%;background:'+v.cor+';color:white;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">'+v.emoji+'</div>'+
          '<div><div style="font-weight:700;font-size:14px;color:'+v.cor+'">'+v.nome+'</div>'+
          '<div style="font-size:13px;color:var(--text);margin-top:2px;line-height:1.5">'+v.desc+'</div></div>'+
        '</div>';
      }).join("")+
      '<div style="margin-top:12px;background:var(--primary-bg);border-radius:8px;padding:12px;font-size:13px;color:var(--text)">üí° '+vozResult.dica+'</div>'+
    '</div>';
  }
  return html;
}
function calcVozes(){
  if(!vozLouvor){alert("Selecione um louvor.");return;}
  var l=louvores.find(function(x){return x.titulo===vozLouvor;})||{};
  vozResult={
    louvor:vozLouvor,tom:l.nota||"",
    soprano:"Canta a melodia principal nas partes mais agudas. No refr√£o pode subir uma ter√ßa acima para enriquecer o arranjo.",
    contralto:"Harmoniza abaixo da melodia. Geralmente uma ter√ßa ou quinta abaixo. √â o alicerce do back vocal feminino.",
    tenor:"Voz masculina mais aguda. Pode dobrar a melodia uma oitava abaixo ou fazer 2¬™ voz masculina. Essencial no clamor.",
    falsete:"Usado em momentos suaves de adora√ß√£o. Cria textura et√©rea e delicada nas pontes e momentos √≠ntimos.",
    segunda:"Canta em ter√ßa ou quarta paralela √† melodia. Com melodia + 2¬™ voz j√° soa completo para grupos pequenos.",
    dica:"Para 3 pessoas: Melodia (Soprano) + 2¬™ Voz + Tenor/Falsete. Para 2 pessoas: Melodia + 2¬™ Voz j√° funciona muito bem!"
  };
  render();
}

// --- METR√îNOMO ---
function setMetroBPM(bpm){
  metroBPM=parseInt(bpm)||80;
  ferraTab="metronomo";
  stopMetro();
  render();
  // Auto-inicia ap√≥s renderizar
  setTimeout(function(){startMetro();},100);
}
function renderMetronomo(){
  var bpmOptions=[60,70,80,90,100,110,120,130,140];
  var html='<div style="background:var(--surface);border-radius:14px;padding:28px 20px;box-shadow:var(--card-shadow);text-align:center">'+
    '<p style="font-size:13px;color:var(--text-soft);margin-bottom:24px">Use o metr√¥nomo para manter o andamento durante o ensaio ou culto.</p>'+
    // C√≠rculo visual
    '<div class="metro-circle '+(metroRunning&&metroBeat?"beat":"")+'">'+metroBPM+'</div>'+
    '<p style="font-size:12px;color:var(--text-soft);margin-top:8px;margin-bottom:24px">BPM</p>'+
    // Slider
    '<div style="max-width:340px;margin:0 auto 20px">'+
      '<input type="range" min="40" max="220" value="'+metroBPM+'" oninput="metroBPM=parseInt(this.value);document.getElementById(\'bpm-num\').textContent=this.value;document.querySelector(\'.metro-circle\').textContent=this.value;if(metroRunning)restartMetro()" '+
        'style="width:100%;accent-color:var(--primary)">'+
      '<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted)"><span>40</span><span>220</span></div>'+
    '</div>'+
    // Input manual
    '<div style="display:flex;gap:8px;justify-content:center;align-items:center;margin-bottom:20px">'+
      '<input type="number" min="40" max="220" value="'+metroBPM+'" id="bpm-num" '+
        'onchange="metroBPM=Math.min(220,Math.max(40,parseInt(this.value)||80));if(metroRunning)restartMetro();render()" '+
        'style="width:80px;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:18px;font-weight:700;text-align:center;background:var(--input-bg);color:var(--text);outline:none">'+
      '<span style="font-size:14px;color:var(--text-soft)">BPM</span>'+
    '</div>'+
    // BPM r√°pidos
    '<div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:24px">'+
      bpmOptions.map(function(b){
        return'<button onclick="metroBPM='+b+';if(metroRunning)restartMetro();render()" '+
          'style="padding:5px 12px;border-radius:16px;border:1px solid var(--border);font-size:12px;cursor:pointer;background:'+(metroBPM===b?"var(--primary)":"var(--surface2)")+';color:'+(metroBPM===b?"white":"var(--text)")+'">'+ b+'</button>';
      }).join("")+
    '</div>'+
    // Refer√™ncias de BPM
    '<div style="background:var(--surface2);border-radius:10px;padding:12px 16px;margin-bottom:24px;text-align:left;max-width:340px;margin-left:auto;margin-right:auto">'+
      '<p style="font-size:11px;font-weight:700;color:var(--text-soft);margin-bottom:8px">REFER√äNCIAS</p>'+
      [["Lento / Adora√ß√£o","50‚Äì75"],["M√©dio / Balada","76‚Äì100"],["Animado","101‚Äì120"],["Agitado / Gospel","121‚Äì150"]].map(function(r){
        return'<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text);padding:3px 0">'+
          '<span>'+r[0]+'</span><span style="font-weight:600;color:var(--primary)">'+r[1]+' BPM</span></div>';
      }).join("")+
    '</div>'+
    // Bot√µes
    '<div style="display:flex;gap:12px;justify-content:center">'+
      '<button onclick="'+(metroRunning?"stopMetro":"startMetro")+'()" '+
        'style="background:'+(metroRunning?"#ef4444":"var(--primary)")+';color:white;border:none;border-radius:12px;padding:12px 32px;font-size:16px;font-weight:700;cursor:pointer">'+
        (metroRunning?"‚èπ Parar":"‚ñ∂ Iniciar")+
      '</button>'+
    '</div>'+
    // Louvores com BPM cadastrado
    (louvores.filter(function(l){return l.bpm;}).length>0?
      '<div style="margin-top:28px;text-align:left"><p style="font-size:12px;font-weight:700;color:var(--text-soft);margin-bottom:10px">LOUVORES CADASTRADOS COM BPM</p>'+
      '<div style="display:flex;flex-wrap:wrap;gap:8px">'+
        louvores.filter(function(l){return l.bpm;}).map(function(l){
          return'<button onclick="metroBPM='+parseInt(l.bpm)+';if(metroRunning)restartMetro();render()" '+
            'style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:8px 14px;font-size:12px;cursor:pointer;text-align:left">'+
            '<div style="font-weight:600;color:var(--text)">'+esc(l.titulo)+'</div>'+
            '<div style="color:var(--primary);font-weight:700">'+l.bpm+' BPM'+(l.nota?" ¬∑ Tom "+l.nota:"")+'</div>'+
          '</button>';
        }).join("")+
      '</div></div>'
    :"")+
  '</div>';
  return html;
}

var metroAudio=null;
function getAudioCtx(){if(!metroAudio)metroAudio=new(window.AudioContext||window.webkitAudioContext)();return metroAudio;}
function playClick(accent){
  var ctx=getAudioCtx();
  var osc=ctx.createOscillator();
  var gain=ctx.createGain();
  osc.connect(gain);gain.connect(ctx.destination);
  osc.frequency.value=accent?1200:800;
  gain.gain.setValueAtTime(0.8,ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.05);
  osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.05);
}
var metroBeatCount=0;
function startMetro(){
  if(metroRunning)return;
  metroRunning=true;metroBeatCount=0;
  var interval=60000/metroBPM;
  metroTimer=setInterval(function(){
    metroBeatCount++;
    var accent=metroBeatCount%4===1;
    playClick(accent);
    metroBeat=true;
    var circ=document.querySelector(".metro-circle");
    if(circ){circ.classList.add("beat");}
    setTimeout(function(){
      metroBeat=false;
      var c=document.querySelector(".metro-circle");
      if(c){c.classList.remove("beat");}
    },80);
  },interval);
  // Re-render s√≥ o c√≠rculo sem rerender tudo
  var circ=document.querySelector(".metro-circle");
  if(circ){
    var btn=document.querySelector("[onclick*='stopMetro']")||document.querySelector("[onclick*='startMetro']");
    if(btn){btn.textContent="‚èπ Parar";btn.style.background="#ef4444";}
  }
}
function stopMetro(){
  if(metroTimer){clearInterval(metroTimer);metroTimer=null;}
  metroRunning=false;metroBeat=false;metroBeatCount=0;
}
function restartMetro(){stopMetro();setTimeout(function(){startMetro();},50);}

// BUSCA POR VOZ
function startVoiceSearch(){
  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert("Seu navegador n√£o suporta busca por voz. Use o Chrome.");return;}
  var rec=new SR();rec.lang="pt-BR";rec.interimResults=false;rec.maxAlternatives=1;
  var btn=document.getElementById("btn-voice");
  if(btn){btn.classList.add("listening");}
  rec.start();
  rec.onresult=function(e){buscaLouvor=e.results[0][0].transcript;render();};
  rec.onerror=function(){if(btn)btn.classList.remove("listening");};
  rec.onend=function(){if(btn)btn.classList.remove("listening");};
}

// INIT
render();
initListeners();
</script>
</body>
</html>
